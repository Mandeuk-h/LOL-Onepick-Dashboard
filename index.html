<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>원픽 내전 // LIVE DATA CENTER</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Gothic+A1:wght@300;400;800&family=JetBrains+Mono:wght@400;800&family=Noto+Sans+KR:wght@300;400;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* CORE THEME */
        :root {
            --bg-color: #050505;
            --surface-color: #0f0f0f;
            --border-color: #333;
            --primary: #ff003c;
            /* Cyber Red */
            --secondary: #00f0ff;
            /* Cyber Cyan */
            --success: #39ff14;
            /* Neon Green */
            --warning: #ffea00;
            /* Warning Yellow */
            --text-main: #e0e0e0;
            --text-dim: #666;
            --grid-line: rgba(255, 255, 255, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Gothic A1', 'JetBrains Mono', sans-serif;
            overflow-x: hidden;
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 50px 50px;
            padding-top: 110px;
            padding-bottom: 40px;
        }

        /* TYPOGRAPHY */
        h1,
        h2,
        h3 {
            font-family: 'Noto Sans KR', sans-serif;
            text-transform: uppercase;
            letter-spacing: -1px;
            line-height: 1.0;
        }

        /* LAYOUT */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        section {
            padding: 80px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 40px;
            border-left: 10px solid var(--primary);
            padding-left: 20px;
        }

        .section-title {
            font-size: 4rem;
            font-weight: 700;
        }

        .section-subtitle {
            font-size: 1.2rem;
            color: var(--secondary);
            font-weight: 700;
            margin-bottom: 5px;
        }

        /* NAV */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(5, 5, 5, 0.95);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            backdrop-filter: blur(5px);
        }

        .nav-logo {
            font-family: 'Black Han Sans';
            font-size: 1.5rem;
            color: #fff;
        }

        .nav-links a {
            color: var(--text-dim);
            margin-left: 30px;
            text-decoration: none;
            font-weight: 700;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .sub-nav {
            position: fixed;
            top: 60px;
            left: 0;
            width: 100%;
            height: 50px;
            background: #000;
            border-bottom: 1px solid var(--primary);
            z-index: 999;
            display: flex;
            align-items: center;
            padding: 0 40px;
            gap: 20px;
            font-size: 0.9rem;
        }

        .version-badge {
            margin-left: auto;
            font-family: 'JetBrains Mono';
            color: var(--success);
            font-weight: bold;
            animation: blink 2s infinite;
        }

        .test-badge {
            background: var(--warning);
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-family: 'JetBrains Mono';
            margin-left: 10px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* CARDS & TABLES */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 200px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--secondary);
        }

        .stat-value {
            font-family: 'Noto Sans KR';
            font-size: 3.5rem;
            color: #fff;
            line-height: 1;
            font-weight: 700;
        }

        .stat-label {
            font-size: 1rem;
            color: var(--text-dim);
            font-weight: 400;
            margin-bottom: 10px;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.1rem;
        }

        .ranking-table th {
            text-align: left;
            padding: 15px;
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 400;
        }

        .ranking-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(15, 15, 15, 0.5);
        }

        /* MATCH HISTORY */
        .match-history-container {
            margin-top: 60px;
            border: 1px solid var(--border-color);
            background: #000;
            overflow-x: auto;
        }

        .match-table-expanded {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            white-space: nowrap;
            min-width: 1800px;
        }

        .match-table-expanded th {
            background: #050505;
            color: #888;
            padding: 8px 6px;
            border-bottom: 2px solid #333;
            font-weight: 400;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .match-table-expanded td {
            padding: 6px;
            border-bottom: 1px solid #222;
            text-align: center;
            vertical-align: middle;
        }

        .team-blue {
            border-left: 4px solid var(--secondary);
            background: rgba(0, 240, 255, 0.02);
        }

        .team-red {
            border-left: 4px solid var(--primary);
            background: rgba(255, 0, 60, 0.02);
        }

        .result-win {
            color: var(--secondary);
            font-weight: bold;
        }

        .result-loss {
            color: #666;
        }

        .champ-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: flex-start;
        }

        /* 이미지 태그로 변경됨 */
        .champ-img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background: #333;
            object-fit: cover;
            border: 1px solid #444;
        }

        .summoner-name {
            font-weight: 400;
            color: #fff;
            text-align: left;
        }

        /* LOADING OVERLAY */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loader {
            border: 5px solid #333;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 5000; /* Below loading (9999), above nav (1000) */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out;
        }

        /* PLAYER PROFILE SECTION */
        #player-profile {
            display: none; /* Hidden by default */
            margin-bottom: 40px;
            background: linear-gradient(135deg, rgba(15, 15, 15, 0.9), rgba(0,0,0,0.9));
            border: 1px solid var(--primary);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        #player-profile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        .profile-name {
            font-size: 3rem;
            font-weight: 700;
            color: #fff;
        }

        .profile-tier {
            font-size: 1.5rem;
            font-family: 'JetBrains Mono';
            padding: 5px 15px;
            background: #222;
            border-radius: 4px;
            color: var(--success);
        }

        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .profile-stat-box {
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border: 1px solid #333;
        }

        .profile-stat-label {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .profile-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #eee;
        }

        .recent-matches-badges {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .match-badge {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: #000;
        }
        .badge-win { background: var(--success); }
        .badge-loss { background: var(--primary); }

        .most-champ-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .most-champ-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #444;
        }

        /* BALANCER */
        .balancer-ui {
            background: #111;
            border: 2px solid var(--border-color);
            padding: 40px;
        }

        .balancer-input-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .balancer-input-grid input {
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-family: 'Noto Sans KR';
        }

        .balancer-result {
            display: none;
            margin-top: 30px;
            border: 2px dashed var(--success);
            padding: 20px;
            background: rgba(57, 255, 20, 0.05);
        }

        .btn-cyber {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 800;
            font-family: 'Noto Sans KR';
            cursor: pointer;
            transition: 0.2s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }

        .btn-cyber:hover {
            background: #fff;
            transform: translateY(-2px);
        }

        .match-block {
            margin-bottom: 30px;
            border: 1px solid #333;
            background: #0a0a0a;
        }

        .match-block-header {
            padding: 12px 20px;
            background: linear-gradient(90deg, #111, #000);
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-date { color: var(--warning); font-weight: bold; }
        .match-duration { color: #888; font-size: 0.9rem; }

        .items-grid {
            display: flex;
            gap: 2px;
            justify-content: center;
        }

        .item-img {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            background: #333;
            border: 1px solid #444;
        }

        /* LANE STATS */
        .lane-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .lane-stat-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            text-align: center;
            transition: 0.2s;
        }

        .lane-stat-card:hover {
            border-color: var(--secondary);
            transform: translateY(-3px);
        }

        .lane-icon { font-size: 2rem; margin-bottom: 10px; }
        .lane-name { font-weight: bold; color: #fff; margin-bottom: 5px; }
        .lane-winrate { font-size: 1.5rem; font-family: 'Black Han Sans'; }

        /* CHAMPION RANKING */
        .champ-ranking-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .champ-rank-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }

        .champ-rank-card:hover { border-color: var(--primary); }

        .champ-rank-img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: #333;
            overflow: hidden;
        }
        
        .champ-rank-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .champ-rank-info { flex: 1; }
        .champ-rank-name { font-weight: bold; color: #fff; }
        .champ-rank-stats { font-size: 0.85rem; color: #888; }

        /* CHART */
        .chart-container {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 20px;
            margin-top: 20px;
        }

        #eloChart { max-height: 400px; }

        /* SEARCH */
        .search-box {
            background: #000;
            border: 2px solid #444;
            padding: 15px 20px;
            font-size: 1rem;
            color: #fff;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }
        .search-box:focus { outline: none; border-color: var(--secondary); }

        /* TOAST MESSAGE */
        #toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 99999;
        }

        .toast {
            background: rgba(0, 0, 0, 0.9);
            border-left: 5px solid var(--primary);
            color: #fff;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-family: 'Noto Sans KR';
            font-size: 0.9rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* TICKER */
        .ticker-wrap {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background-color: var(--primary);
            color: #000;
            z-index: 999;
            line-height: 40px;
            font-weight: 800;
            border-top: 2px solid #000;
            font-family: 'Noto Sans KR';
            font-size: 0.9rem;
        }
        .ticker {
            display: inline-block;
            white-space: nowrap;
            animation: ticker 40s linear infinite;
        }
        .ticker-item {
            display: inline-block;
            padding: 0 2rem;
        }
    </style>
</head>

<body>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <div style="font-family: 'JetBrains Mono'; color: #fff; text-align: center;">
            CONNECTING TO GOOGLE SPREADSHEET...<br>
            <span id="display-sheet-id" style="font-size: 0.8rem; color: #666;">ID: INITIALIZING...</span>
            <div id="connection-status" style="margin-top:10px; font-weight:bold; font-size:0.9rem;"></div>
        </div>
    </div>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
        <h1 class="section-title glitch-text" style="font-size: 5rem; margin-bottom: 20px;">원픽 내전</h1>
        <div class="section-subtitle" style="margin-bottom: 40px;">LIVE DATA CENTER</div>
        
        <div style="width: 100%; max-width: 500px; padding: 0 20px;">
            <input type="text" id="login-input" class="search-box" placeholder="소환사명을 입력하세요" style="font-size: 1.5rem; text-align: center; margin-bottom: 20px;" onkeyup="if(event.key === 'Enter') attemptLogin()">
            <button class="btn-cyber" onclick="attemptLogin()" style="width: 100%; font-size: 1.5rem;">내 전적 검색 (로그인)</button>
            <button onclick="guestLogin()" style="background:none; border:none; color:#666; text-decoration:underline; cursor:pointer; margin-top:15px; font-size:0.9rem;">게스트로 입장하기</button>
        </div>
        <div id="login-msg" style="margin-top: 20px; color: var(--primary); min-height: 20px; font-weight:bold;"></div>
    </div>

    <!-- TOAST MSG -->
    <div id="toast-container"></div>

    <!-- NAV -->
    <nav>
        <div class="nav-logo">원픽 내전 // LIVE DATA</div>
        <div class="nav-links">
            <a href="#dashboard">대시보드</a>
            <a href="#ranking">리더보드</a>
            <a href="#matches">경기기록</a>
            <a href="#lane-stats">라인별 승률</a>
            <a href="#champ-ranking">챔피언 순위</a>
            <a href="#elo-timeline">ELO 타임라인</a>
            <a href="#balancer">팀 밸런서</a>
        </div>
    </nav>

    <div class="sub-nav">
        <div id="status-text" style="color:#aaa;">
            <i class="fa-solid fa-circle-check" style="color:var(--text-dim)"></i> 시스템 대기 중
        </div>
        <div class="version-badge" id="last-update-time">
            UPDATING...
        </div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard">
        <div class="container">
            <!-- PLAYER PROFILE (HIDDEN BY DEFAULT) -->
            <div id="player-profile">
                <div class="profile-header">
                    <div style="flex:1;">
                        <span class="profile-tier" id="p-tier">-</span>
                        <h2 class="profile-name" id="p-name">Player Name</h2>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:3rem; font-weight:bold; color:var(--secondary);" id="p-elo">1000</div>
                        <div style="color:#888;">Current MMR</div>
                    </div>
                </div>
                
                <div class="profile-stats-grid">
                    <div class="profile-stat-box">
                        <div class="profile-stat-label">시즌 전적</div>
                        <div class="profile-stat-value" id="p-record">-</div>
                        <div style="color:#666; font-size:0.8rem;" id="p-winrate">-</div>
                    </div>
                    <div class="profile-stat-box">
                        <div class="profile-stat-label">평균 KDA</div>
                        <div class="profile-stat-value" style="color:var(--success);" id="p-kda">-</div>
                    </div>
                    <div class="profile-stat-box">
                        <div class="profile-stat-label">모스트 챔피언</div>
                        <div id="p-most-champs">
                            <!-- JS Populated -->
                        </div>
                    </div>
                    <div class="profile-stat-box">
                        <div class="profile-stat-label">최근 5경기</div>
                        <div class="recent-matches-badges" id="p-recent">
                            <!-- JS Populated -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-header">
                <div>
                    <div class="section-subtitle">LIVE STATUS</div>
                    <h2 class="section-title">대시보드</h2>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-label">총 경기 수 (Logs)</div>
                    <div class="stat-value" id="dash-total-games">-</div>
                </div>
                <div class="stat-card" style="border-color: var(--primary);">
                    <div class="stat-label">등록된 선수</div>
                    <div class="stat-value" id="dash-total-players">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">1위 최고 점수</div>
                    <div class="stat-value" style="color:var(--secondary)" id="dash-top-mmr">-</div>
                    <div id="dash-top-player" style="margin-top:auto; color:#888;">-</div>
                </div>
                <div class="stat-card" style="border-color: var(--warning);">
                    <div class="stat-label">최근 경기</div>
                    <div class="stat-value" style="font-size: 2.5rem;" id="dash-last-match-id">-</div>
                    <div id="dash-last-match-date" style="margin-top:auto; color:#888;">-</div>
                </div>
            </div>

            <!-- RISING & FALLING -->
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 40px;">
                <div style="border: 1px solid #333; padding: 30px; background: #0a0a0a;">
                    <h3 style="color: var(--success); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                        <i class="fa-solid fa-arrow-trend-up"></i> 최근 떡상 (MMR 급상승)
                    </h3>
                    <div id="rising-list">
                        <div style="color:#666;">데이터 로딩 중...</div>
                    </div>
                </div>

                <div style="border: 1px solid #333; padding: 30px; background: #0a0a0a;">
                    <h3 style="color: var(--primary); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                        <i class="fa-solid fa-arrow-trend-down"></i> 최근 떡락 (MMR 급하락)
                    </h3>
                    <div id="falling-list">
                        <div style="color:#666;">데이터 로딩 중...</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- RANKING -->
    <section id="ranking">
        <div class="container">
            <div class="section-header">
                <div>
                    <div class="section-subtitle">ELO RANKING</div>
                    <h2 class="section-title">리더보드</h2>
                </div>
            </div>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th width="10%">순위</th>
                        <th width="40%">소환사명</th>
                        <th width="25%">ELO 점수</th>
                        <th width="25%">티어 (추정)</th>
                    </tr>
                </thead>
                <tbody id="ranking-tbody">
                    <!-- JS Populated -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- TEAM BALANCER -->
    <section id="balancer">
        <div class="container">
            <div class="section-header" style="border-left-color: var(--success);">
                <div>
                    <div class="section-subtitle">시뮬레이터</div>
                    <h2 class="section-title">자동 팀 밸런스</h2>
                </div>
            </div>

            <div class="balancer-ui">
                <p style="margin-bottom: 20px; color: #ccc;">
                    > 참여할 소환사 10명을 입력하면 <strong>실시간 ELO 데이터</strong>를 기반으로 팀을 구성합니다.
                </p>

                <div class="balancer-input-grid" id="balancer-inputs">
                    <!-- Inputs generated by JS -->
                </div>

                <button class="btn-cyber" onclick="calculateBalance()">
                    밸런스 분석 시작
                </button>

                <div class="balancer-result" id="balancer-result">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>
    </section>

    <!-- MATCH HISTORY (Expanded with All Columns) -->
    <section id="matches">
        <div class="container">
            <div class="section-header" style="border-left-color: var(--warning);">
                <div>
                    <div class="section-subtitle">FULL MATCH DATA</div>
                    <h2 class="section-title">경기 기록</h2>
                </div>
            </div>

            <div id="matches-container">
                <!-- JS Populated - Each match block will be added here -->
                <div style="color:#666; text-align:center; padding:40px;">데이터 로딩 중...</div>
            </div>
        </div>
    </section>

    <!-- LANE STATS SECTION -->
    <section id="lane-stats">
        <div class="container">
            <div class="section-header" style="border-left-color: var(--secondary);">
                <div>
                    <div class="section-subtitle">POSITION ANALYTICS</div>
                    <h2 class="section-title">라인별 승률</h2>
                </div>
            </div>
            <div class="lane-stats-grid" id="lane-stats-grid">
                <!-- JS Populated -->
            </div>
        </div>
    </section>

    <!-- CHAMPION RANKING SECTION -->
    <section id="champ-ranking">
        <div class="container">
            <div class="section-header" style="border-left-color: #d633ff;">
                <div>
                    <div class="section-subtitle">CHAMPION META</div>
                    <h2 class="section-title">챔피언 순위</h2>
                </div>
            </div>
            <div class="champ-ranking-grid" id="champ-ranking-grid">
                <!-- JS Populated -->
            </div>
        </div>
    </section>

    <!-- ELO TIMELINE SECTION -->
    <section id="elo-timeline">
        <div class="container">
            <div class="section-header" style="border-left-color: var(--success);">
                <div>
                    <div class="section-subtitle">RATING HISTORY</div>
                    <h2 class="section-title">ELO 타임라인</h2>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <input type="text" class="search-box" id="elo-player-search" placeholder="선수 이름 검색... (예: Faker)">
            </div>
            <div class="chart-container">
                <canvas id="eloChart"></canvas>
            </div>
        </div>
    </section>

    <!-- TICKER -->
    <div class="ticker-wrap">
        <div class="ticker" id="ticker-content">
            <div class="ticker-item">SYSTEM INITIALIZING... DATA STREAM LOADING...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // [설정 영역]
        // ==========================================
        const CONFIG = {
            testMode: false, 
            sheetId: '13-xiV7yy5KcEn01u898cpvsv7N5lOLXUQMflTRFMSnY', 
            sheets: {
                ranking: 'ELO 순위표',
                logs: 'Logs',
                matches: '경기기록',
                laneStats: '라인별 승률',
                champRanking: '챔프 순위',
                eloTimeline: 'ELO 타임라인',
                db1: 'DB1' // 참여자 ID 목록 (B열)
            }
        };
        // ==========================================

        // 한글 챔피언 이름 -> Riot Data Dragon Key 매핑 (공백 제거 후 검색)
        const CHAMP_KR_TO_EN = {
            "가렌": "Garen", "갈리오": "Galio", "갱플랭크": "Gangplank", "그라가스": "Gragas", "그레이브즈": "Graves",
            "그웬": "Gwen", "나르": "Gnar", "나미": "Nami", "나서스": "Nasus", "나피리": "Naafiri",
            "노틸러스": "Nautilus", "녹턴": "Nocturne", "누누": "Nunu", "누누와윌럼프": "Nunu", "니달리": "Nidalee", "니코": "Neeko",
            "닐라": "Nilah", "다리우스": "Darius", "다이애나": "Diana", "드레이븐": "Draven", "라이즈": "Ryze",
            "라칸": "Rakan", "람머스": "Rammus", "럭스": "Lux", "럼블": "Rumble", "레나타": "Renata", "레나타글라스크": "Renata",
            "레넥톤": "Renekton", "레오나": "Leona", "렉사이": "RekSai", "렐": "Rell", "렝가": "Rengar",
            "루시안": "Lucian", "룰루": "Lulu", "르블랑": "Leblanc", "리신": "LeeSin", "리븐": "Riven",
            "리산드라": "Lissandra", "릴리아": "Lillia", "마스터이": "MasterYi", "마오카이": "Maokai", "마이": "MasterYi",
            "말자하": "Malzahar", "말파이트": "Malphite", "모데카이저": "Mordekaiser", "모르가나": "Morgana", "문도": "DrMundo", "문도박사": "DrMundo",
            "미스포츈": "MissFortune", "미포": "MissFortune", "밀리오": "Milio", "바드": "Bard", "바루스": "Varus",
            "바이": "Vi", "베이가": "Veigar", "베인": "Vayne", "벡스": "Vex", "벨베스": "Belveth",
            "벨코즈": "Velkoz", "볼리베어": "Volibear", "브라움": "Braum", "브라이어": "Briar", "브랜드": "Brand",
            "블라디미르": "Vladimir", "블리츠크랭크": "Blitzcrank", "블리츠": "Blitzcrank", "비에고": "Viego", "빅토르": "Viktor", "뽀삐": "Poppy",
            "사미라": "Samira", "사이온": "Sion", "사일러스": "Sylas", "샤코": "Shaco", "세나": "Senna",
            "세라핀": "Seraphine", "세주아니": "Sejuani", "세트": "Sett", "소나": "Sona", "소라카": "Soraka",
            "쉔": "Shen", "쉬바나": "Shyvana", "스웨인": "Swain", "스카너": "Skarner", "스몰더": "Smolder", "시비르": "Sivir",
            "신짜오": "XinZhao", "신드라": "Syndra", "신지드": "Singed", "쓰레쉬": "Thresh",
            "아리": "Ahri", "아무무": "Amumu", "아우렐리온솔": "AurelionSol", "아우솔": "AurelionSol", "아이번": "Ivern",
            "아지르": "Azir", "아칼리": "Akali", "아크샨": "Akshan", "아트록스": "Aatrox", "아펠리오스": "Aphelios", "아펠": "Aphelios",
            "알리스타": "Alistar", "암베사": "Ambessa", "애니": "Annie", "애니비아": "Anivia", "애쉬": "Ashe",
            "야스오": "Yasuo", "에코": "Ekko", "엘리스": "Elise", "오공": "MonkeyKing", "오른": "Ornn", "오로라": "Aurora",
            "오리아나": "Orianna", "올라프": "Olaf", "요네": "Yone", "요릭": "Yorick", "우디르": "Udyr",
            "우르곳": "Urgot", "워윅": "Warwick", "유미": "Yuumi", "이렐리아": "Irelia", "이브린": "Evelynn", "이블린": "Evelynn",
            "이즈리얼": "Ezreal", "일라오이": "Illaoi", "자르반": "JarvanIV", "자르반4세": "JarvanIV", "자야": "Xayah",
            "자이라": "Zyra", "자크": "Zac", "잔나": "Janna", "잭스": "Jax", "제드": "Zed",
            "제라스": "Xerath", "제리": "Zeri", "제이스": "Jayce", "조이": "Zoe", "직스": "Ziggs",
            "진": "Jhin", "질리언": "Zilean", "징크스": "Jinx", "초가스": "Chogath", "카르마": "Karma",
            "카밀": "Camille", "카사딘": "Kassadin", "카서스": "Karthus", "카시오페아": "Cassiopeia", "카이사": "Kaisa",
            "카직스": "Khazix", "카타리나": "Katarina", "칼리스타": "Kalista", "케넨": "Kennen", "케이틀린": "Caitlyn",
            "케인": "Kayn", "케일": "Kayle", "코그모": "KogMaw", "코르키": "Corki", "퀸": "Quinn",
            "크산테": "KSante", "클레드": "Kled", "키아나": "Qiyana", "킨드레드": "Kindred", "타릭": "Taric",
            "탈론": "Talon", "탈리야": "Taliyah", "탐켄치": "TahmKench", "트런들": "Trundle", "트리스타나": "Tristana",
            "트린다미어": "Tryndamere", "트위스티드페이트": "TwistedFate", "트페": "TwistedFate", "트위치": "Twitch", "티모": "Teemo",
            "파이크": "Pyke", "판테온": "Pantheon", "피들스틱": "Fiddlesticks", "피오라": "Fiora", "피즈": "Fizz",
            "하이머딩거": "Heimerdinger", "헤카림": "Hecarim", "흐웨이": "Hwei"
        };

        // 이미지 주소 생성 함수
        function getChampImg(koreanName) {
            if (!koreanName) return 'https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Poro_0.jpg';
            const cleanName = koreanName.replace(/\s+/g, '');
            const enName = CHAMP_KR_TO_EN[cleanName] || CHAMP_KR_TO_EN[koreanName] || cleanName;
            return `https://ddragon.leagueoflegends.com/cdn/14.2.1/img/champion/${enName}.png`;
        }

        // Global Data Storage
        let GLOBAL_DATA = {
            ranking: [],
            logs: [],
            matches: [],
            laneStats: [],
            champRanking: [],
            eloTimeline: [],
            db1: [] // ID 목록
        };

        let eloChart = null; 

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (type === 'error') toast.style.borderLeftColor = 'red';
            if (type === 'success') toast.style.borderLeftColor = 'var(--success)';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function getQueryUrl(sheetName, query = 'SELECT *', responseHandler) {
            const encodedQuery = encodeURIComponent(query);
            const encodedSheet = encodeURIComponent(sheetName);
            const tqx = responseHandler ? `out:json;responseHandler:${responseHandler}` : 'out:json';
            return `https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq?tqx=${tqx}&sheet=${encodedSheet}&tq=${encodedQuery}`;
        }

        // --- MOCK DATA (FOR TEST MODE) ---
        function getMockData(sheetName) {
             if (sheetName === CONFIG.sheets.ranking) {
                return [
                    [1, 'Faker', 2500], [2, 'Chovy', 2450], [3, 'ShowMaker', 2300], 
                    [4, 'Zeka', 2250], [5, 'Bdd', 2100], [6, 'Clozer', 2050],
                    [7, 'Keria', 1900], [8, 'Zeus', 1850], [9, 'Oner', 1800],
                    [10, 'Gumayusi', 1750]
                ];
            }
            if (sheetName === CONFIG.sheets.db1) {
                // Mock ID list: [ID, Tier, Score]
                return [['Faker', 'CHALLENGER', 2500], ['Chovy', 'CHALLENGER', 2450], ['ShowMaker', 'GRANDMASTER', 2300]];
            }
            if (sheetName === CONFIG.sheets.logs) {
                return [
                    ['2024-01-01', 1, 'BLUE', 'RED', '승리', 25],
                    ['2024-01-01', 2, 'RED', 'BLUE', '승리', 20],
                    ['2024-01-02', 3, 'BLUE', 'RED', '승리', -15],
                    ['2024-01-03', 4, 'BLUE', 'RED', '승리', 30], 
                    ['2024-01-04', 5, 'RED', 'BLUE', '승리', -25] 
                ];
            }
            if (sheetName === CONFIG.sheets.matches) {
                const createRow = (team, id, name, champ, win, k, d, a) => [
                    team, id, name, '', champ, 18, win, k, d, a, 50, 25000, 15000, 12000, 10, 2, 
                    '무한의 대검', '고속 연사포', '유령 무희', '도미닉 경의 인사', '피바라기', '광전사의 군화', '망원형 개조'
                ];
                return [
                    createRow('BLUE', 5, 'Faker', '오리아나', '승리', 5, 2, 10),
                    createRow('BLUE', 5, 'Oner', '리 신', '승리', 4, 3, 12),
                    createRow('BLUE', 5, 'Zeus', '아트록스', '승리', 6, 4, 8),
                    createRow('BLUE', 5, 'Gumayusi', '징크스', '승리', 8, 1, 5),
                    createRow('BLUE', 5, 'Keria', '쓰레쉬', '승리', 1, 4, 15),
                    createRow('RED', 5, 'Chovy', '아지르', '패배', 3, 5, 2),
                    createRow('RED', 5, 'Canyon', '니달리', '패배', 2, 6, 4),
                    createRow('RED', 5, 'Kiin', '크산테', '패배', 4, 4, 3),
                    createRow('RED', 5, 'Peyz', '제리', '패배', 5, 5, 3),
                    createRow('RED', 5, 'Lehends', '라칸', '패배', 0, 7, 6)
                ];
            }
            if (sheetName === CONFIG.sheets.laneStats) {
                return [
                    ['TOP', 50, 25, 0, 0, 0, 0, '3.5', '50%', 0, 'Zeus'],
                    ['JG', 50, 26, 0, 0, 0, 0, '4.2', '52%', 0, 'Oner'],
                    ['MID', 50, 30, 0, 0, 0, 0, '5.1', '60%', 0, 'Faker'],
                    ['ADC', 50, 24, 0, 0, 0, 0, '3.8', '48%', 0, 'Gumayusi'],
                    ['SUP', 50, 25, 0, 0, 0, 0, '4.5', '50%', 0, 'Keria']
                ];
            }
            if (sheetName === CONFIG.sheets.champRanking) {
                return [
                    ['오리아나', 20, 12, 0, 0, 0, 0, '4.5', '60%'],
                    ['리 신', 18, 9, 0, 0, 0, 0, '3.2', '50%'],
                    ['아트록스', 15, 8, 0, 0, 0, 0, '2.8', '53%'],
                    ['징크스', 12, 7, 0, 0, 0, 0, '4.0', '58%'],
                    ['쓰레쉬', 10, 5, 0, 0, 0, 0, '3.5', '50%']
                ];
            }
            if (sheetName === CONFIG.sheets.eloTimeline) {
                return [
                    [1, 'Game 1', 'Faker', 1025],
                    [2, 'Game 2', 'Faker', 1050],
                    [3, 'Game 3', 'Faker', 1075]
                ];
            }
            return [];
        }

        function fetchData(sheetName, query) {
            if (CONFIG.testMode) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve(getMockData(sheetName));
                    }, 300);
                });
            }

            return new Promise((resolve) => {
                const callbackName = `__sheetCb_${Date.now()}_${Math.random().toString(36).slice(2)}`;
                const script = document.createElement('script');
                let finished = false;

                const cleanup = () => {
                    if (finished) return;
                    finished = true;
                    delete window[callbackName];
                    script.remove();
                    clearTimeout(timeout);
                };

                const timeout = setTimeout(() => {
                    cleanup();
                    console.error(`Error fetching ${sheetName}: timeout`);
                    resolve(null);
                }, 10000);

                window[callbackName] = (response) => {
                    cleanup();
                    if (!response || response.status !== 'ok' || !response.table) {
                        console.error(`Error fetching ${sheetName}: invalid response`, response);
                        resolve(null);
                        return;
                    }
                    const rows = response.table.rows.map(r => r.c.map(cell => cell ? (cell.v !== null ? cell.v : '') : ''));
                    resolve(rows);
                };

                script.onerror = () => {
                    cleanup();
                    console.error(`Error fetching ${sheetName}: network error`);
                    resolve(null);
                };

                script.src = getQueryUrl(sheetName, query, callbackName);
                document.head.appendChild(script);
            });
        }

        // --- LOGIN LOGIC ---
        function attemptLogin() {
            const input = document.getElementById('login-input');
            const name = input.value.trim();
            const msg = document.getElementById('login-msg');

            if (!name) {
                msg.textContent = "소환사명을 입력해주세요.";
                return;
            }

            // DB1 check: row[0] is ID.
            // Data fetched: [ID, Tier, Score]
            let validUser = false;
            
            // Check in DB1 list first
            if (GLOBAL_DATA.db1 && GLOBAL_DATA.db1.length > 0) {
                validUser = GLOBAL_DATA.db1.some(row => row[0] && row[0].toString().toLowerCase() === name.toLowerCase());
            }

            // Fallback to Ranking list if DB1 is empty or not found (optional safety)
            if (!validUser) {
                validUser = GLOBAL_DATA.ranking.some(row => row[1] && row[1].toLowerCase() === name.toLowerCase());
            }
            
            if (!validUser && !CONFIG.testMode) {
                msg.textContent = `⚠️ 등록되지 않은 ID입니다. (관리자에게 문의하세요)`;
                return; 
            }

            // Success Transition
            const loginOverlay = document.getElementById('login-overlay');
            loginOverlay.style.opacity = 0;
            
            setTimeout(() => {
                loginOverlay.style.display = 'none';
                
                // Show Personal Profile
                renderPlayerProfile(name);

                // Auto-search in ELO Timeline
                const eloSearch = document.getElementById('elo-player-search');
                if(eloSearch) {
                    eloSearch.value = name;
                    eloSearch.dispatchEvent(new Event('input'));
                }
                
                showToast(`${name}님 환영합니다!`, 'success');
            }, 500);
        }

        function guestLogin() {
            const loginOverlay = document.getElementById('login-overlay');
            loginOverlay.style.opacity = 0;
            setTimeout(() => {
                loginOverlay.style.display = 'none';
                showToast('게스트 모드로 접속했습니다.');
            }, 500);
        }

        // --- NEW: RENDER PLAYER PROFILE ---
        function renderPlayerProfile(name) {
            const profileSection = document.getElementById('player-profile');
            
            // NEW: Fetch from DB1 (columns B, D, H -> index 0, 1, 2)
            const userDbData = GLOBAL_DATA.db1.find(row => row[0] && row[0].toString().toLowerCase() === name.toLowerCase());
            
            // Basic Info
            const elo = userDbData ? userDbData[2] : 1000; // Column H (Score)
            const tier = userDbData ? userDbData[1] : 'UNRANKED'; // Column D (Tier)

            document.getElementById('p-name').textContent = name;
            document.getElementById('p-elo').textContent = elo;
            document.getElementById('p-tier').textContent = tier;
            
            // Calculate Stats from Matches
            // Match row indices: 2=Name, 4=Champ, 6=Result, 7=K, 8=D, 9=A
            const myMatches = [];
            GLOBAL_DATA.matches.forEach(m => {
                // Check every row (10 rows per match)
                if(m[2] && m[2].toLowerCase() === name.toLowerCase()) {
                    myMatches.push(m);
                }
            });

            const totalGames = myMatches.length;
            const wins = myMatches.filter(m => m[6] === '승리').length;
            const losses = totalGames - wins;
            const winRate = totalGames > 0 ? Math.round((wins / totalGames) * 100) : 0;

            document.getElementById('p-record').textContent = `${totalGames}전 ${wins}승 ${losses}패`;
            document.getElementById('p-winrate').textContent = `승률 ${winRate}%`;

            // KDA
            let totalK = 0, totalD = 0, totalA = 0;
            myMatches.forEach(m => {
                totalK += (m[7] || 0);
                totalD += (m[8] || 0);
                totalA += (m[9] || 0);
            });
            const avgKda = totalD === 0 ? (totalK + totalA) : ((totalK + totalA) / totalD).toFixed(2);
            document.getElementById('p-kda').textContent = `${avgKda}:1`;

            // Most Champs
            const champCounts = {};
            myMatches.forEach(m => {
                const c = m[4];
                if(!champCounts[c]) champCounts[c] = { games: 0, wins: 0 };
                champCounts[c].games++;
                if(m[6] === '승리') champCounts[c].wins++;
            });
            
            const sortedChamps = Object.keys(champCounts).sort((a,b) => champCounts[b].games - champCounts[a].games).slice(0, 3);
            const mostHtml = sortedChamps.map(c => {
                const data = champCounts[c];
                const rate = Math.round((data.wins / data.games) * 100);
                return `
                <div class="most-champ-item">
                    <img class="most-champ-img" src="${getChampImg(c)}" title="${c}">
                    <div>
                        <div style="font-weight:bold; font-size:0.9rem;">${c}</div>
                        <div style="font-size:0.8rem; color:#888;">${data.games}게임 (${rate}%)</div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('p-most-champs').innerHTML = mostHtml || '<div style="color:#666;">기록 없음</div>';

            // Recent 5
            // Sort matches by date if possible, but assuming input order is chronological, take last 5
            const recent = myMatches.slice(-5); // Reverse if needed
            const recentHtml = recent.map(m => {
                const isWin = m[6] === '승리';
                return `<div class="match-badge ${isWin ? 'badge-win' : 'badge-loss'}">${isWin ? 'W' : 'L'}</div>`;
            }).join('');
            document.getElementById('p-recent').innerHTML = recentHtml || '<div style="color:#666;">-</div>';

            // Show section
            profileSection.style.display = 'block';
        }

        // --- LOGIC: RISING/FALLING ---
        function updateRisingFalling(logs) {
            const recentLogs = logs.slice(-50);
            const changes = recentLogs.map(log => ({
                name: log[2],
                change: parseInt(log[5]) || 0
            })).filter(item => item.change !== 0);

            const rising = changes.filter(c => c.change > 0).sort((a, b) => b.change - a.change).slice(0, 3);
            const falling = changes.filter(c => c.change < 0).sort((a, b) => a.change - b.change).slice(0, 3);

            const risingDiv = document.getElementById('rising-list');
            risingDiv.innerHTML = rising.length ? '' : '데이터 없음';
            rising.forEach((r, i) => {
                risingDiv.innerHTML += `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #333; padding-bottom: 5px;">
                    <span>#${i + 1} ${r.name}</span>
                    <span style="color: var(--success); font-weight:bold;">+${r.change} MMR</span>
                </div>`;
            });

            const fallingDiv = document.getElementById('falling-list');
            fallingDiv.innerHTML = falling.length ? '' : '데이터 없음';
            falling.forEach((r, i) => {
                fallingDiv.innerHTML += `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #333; padding-bottom: 5px;">
                    <span>#${i + 1} ${r.name}</span>
                    <span style="color: var(--primary); font-weight:bold;">${r.change} MMR</span>
                </div>`;
            });
        }

        // --- LOGIC: TICKER ---
        function updateTicker(logs) {
            const tickerDiv = document.getElementById('ticker-content');
            tickerDiv.innerHTML = '';
            
            if(logs.length === 0) {
                 tickerDiv.innerHTML += `<div class="ticker-item">현재 등록된 경기 기록이 없습니다. 시즌 시작을 준비하세요!</div>`;
                 return;
            }

            const matches = [];
            const processedIds = new Set();

            for (let i = logs.length - 1; i >= 0; i--) {
                const row = logs[i];
                const matchId = row[1];
                if (!processedIds.has(matchId)) {
                    if (row[4] === '승리') {
                        matches.push(`매치 #${matchId}: ${row[2]}팀 승리`);
                        processedIds.add(matchId);
                    }
                }
                if (matches.length >= 5) break;
            }

            matches.forEach(text => {
                tickerDiv.innerHTML += `<div class="ticker-item">${text}</div>`;
            });

            const statusText = CONFIG.testMode ? '[테스트 모드 작동 중]' : `[시스템] 실시간 데이터 연동 완료 (${CONFIG.sheetId})`;
            tickerDiv.innerHTML += `<div class="ticker-item" style="color:var(--warning);">${statusText}</div>`;
        }

        // --- LOGIC: BALANCER ---
        function updatePlayerDatalist() {
            let datalist = document.getElementById('player-options');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'player-options';
                document.body.appendChild(datalist);
            }
            datalist.innerHTML = '';
            
            // DB1 data structure: [Name, Tier, Score]
            // Skip header if first row is not a name (optional basic check)
            GLOBAL_DATA.db1.forEach((row, idx) => {
                // If it's a mock header or empty
                if (!row[0] || (idx === 0 && row[0] === 'ID')) return;
                
                const option = document.createElement('option');
                option.value = row[0];
                datalist.appendChild(option);
            });
        }

        function initBalancerInputs() {
            const grid = document.getElementById('balancer-inputs');
            grid.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                // Added list="player-options" for autocomplete
                grid.innerHTML += `<input type="text" id="p${i}" list="player-options" placeholder="참가자 ${i + 1} 선택" autocomplete="off">`;
            }
        }

        function calculateBalance() {
            const resultDiv = document.getElementById('balancer-result');
            const players = [];

            for (let i = 0; i < 10; i++) {
                const name = document.getElementById(`p${i}`).value.trim();
                if (!name) continue;
                
                // Lookup MMR from DB1 instead of Ranking
                // DB1 structure: [Name, Tier, Score] -> Index 0, 1, 2
                const found = GLOBAL_DATA.db1.find(r => r[0] && r[0].toString().toLowerCase() === name.toLowerCase());
                const mmr = found ? parseInt(found[2]) : 1000;
                
                players.push({ name, mmr });
            }

            if (players.length < 10) {
                showToast(`10명의 선수가 필요합니다. (현재 ${players.length}명)`, 'error');
                return;
            }

            players.sort((a, b) => b.mmr - a.mmr);

            const teamA = [players[0], players[3], players[4], players[7], players[8]];
            const teamB = [players[1], players[2], players[5], players[6], players[9]];

            const sumA = teamA.reduce((a, b) => a + b.mmr, 0);
            const sumB = teamB.reduce((a, b) => a + b.mmr, 0);
            const avgA = Math.round(sumA / 5);
            const avgB = Math.round(sumB / 5);

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
            <h3 style="color:var(--success); margin-bottom:15px;">[분석 완료] 최적 밸런스 제안</h3>
            <div style="display:flex; justify-content:space-between; gap:20px;">
                <div style="flex:1; background:#000; padding:15px; border:1px solid #444;">
                    <div style="color:var(--secondary); font-weight:bold; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">
                        🔵 블루팀 (평균: ${avgA})
                    </div>
                    ${teamA.map(p => `<div>${p.name} <span style="color:#666; font-size:0.8rem;">(${p.mmr})</span></div>`).join('')}
                </div>
                <div style="flex:1; background:#000; padding:15px; border:1px solid #444;">
                    <div style="color:var(--primary); font-weight:bold; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">
                        🔴 레드팀 (평균: ${avgB})
                    </div>
                    ${teamB.map(p => `<div>${p.name} <span style="color:#666; font-size:0.8rem;">(${p.mmr})</span></div>`).join('')}
                </div>
            </div>
            <div style="margin-top:15px; text-align:center; font-size:0.9rem; color:#888;">
                MMR 차이: ${Math.abs(avgA - avgB)}점
            </div>
        `;
        }

        // --- LOGIC: RENDER MATCHES (EXPANDED) ---
        function renderMatches(matchData) {
            const container = document.getElementById('matches-container');
            if (!matchData || matchData.length === 0) {
                container.innerHTML = '<div style="color:#666; text-align:center; padding:40px;">경기 데이터가 없습니다.</div>';
                return;
            }

            const matchGroups = [];
            for (let i = 0; i < matchData.length; i += 10) {
                matchGroups.push(matchData.slice(i, i + 10));
            }

            const recentMatches = matchGroups.slice(-5).reverse();

            container.innerHTML = recentMatches.map((match, idx) => {
                const rows = match.map(row => {
                    const teamVal = row[0] || '';
                    const isBlue = teamVal.toUpperCase().includes('BLUE');
                    const resultVal = row[6] || '';
                    const isWin = resultVal === '승리';
                    const champName = row[4] || '';

                    const items = [row[16], row[17], row[18], row[19], row[20], row[21]].filter(Boolean);
                    const trinket = row[22] || '';

                    return `
                    <tr class="${isBlue ? 'team-blue' : 'team-red'}">
                        <td style="font-weight:bold; color:${isBlue ? 'var(--secondary)' : 'var(--primary)'}">${teamVal}</td>
                        <td>${row[1] || ''}</td>
                        <td style="text-align:left;">
                            <div class="champ-cell">
                                <img class="champ-img" src="${getChampImg(champName)}" onerror="this.src='https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Poro_0.jpg'" alt="${champName}">
                                <div>
                                    <div class="summoner-name">${row[2] || ''}</div>
                                    <div style="font-size:0.7rem; color:#888;">${champName}</div>
                                </div>
                            </div>
                        </td>
                        <td>${row[5] || ''}</td>
                        <td class="${isWin ? 'result-win' : 'result-loss'}">${resultVal}</td>
                        <td>${row[7] || 0}/${row[8] || 0}/${row[9] || 0}</td>
                        <td>${row[10] || 0}</td>
                        <td>${Number(row[11] || 0).toLocaleString()}</td>
                        <td>${Number(row[12] || 0).toLocaleString()}</td>
                        <td style="color:#f1c40f">${Number(row[13] || 0).toLocaleString()}</td>
                        <td>${row[14] || 0}</td>
                        <td>${row[15] || 0}</td>
                        <td>
                            <div class="items-grid">
                                ${items.map(item => `<div class="item-img" title="${item}"></div>`).join('')}
                                ${trinket ? `<div class="item-img" style="border-color:#ffea00;" title="${trinket}"></div>` : ''}
                            </div>
                        </td>
                    </tr>`;
                }).join('');

                return `
                <div class="match-block">
                    <div class="match-block-header">
                        <span class="match-date">매치 #${recentMatches.length - idx}</span>
                        <span class="match-duration">경기기록 시트 데이터</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="match-table-expanded">
                            <thead>
                                <tr>
                                    <th>팀</th><th>포지션</th><th style="text-align:left;">소환사/챔피언</th>
                                    <th>레벨</th><th>결과</th><th>K/D/A</th><th>시야</th>
                                    <th>피해량</th><th>받은 피해</th><th>골드</th><th>CC</th><th>핑와</th><th>아이템</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>`;
            }).join('');
        }

        // --- LOGIC: RENDER LANE STATS ---
        function renderLaneStats(laneData) {
            const grid = document.getElementById('lane-stats-grid');
            if (!laneData || laneData.length === 0) {
                grid.innerHTML = '<div style="color:#666;">라인 데이터가 없습니다.</div>';
                return;
            }

            const icons = { 'TOP': '🗡️', 'JG': '🌲', 'MID': '⚡', 'ADC': '🎯', 'SUP': '🛡️' };

            grid.innerHTML = laneData.slice(0, 5).map(row => {
                const pos = row[0] || '';
                const games = row[1] || 0;
                const wins = row[2] || 0;
                const winrate = row[8] || '0%';
                const kda = row[7] || '0.0';
                const pog = row[10] || '-';

                return `
                <div class="lane-stat-card">
                    <div class="lane-icon">${icons[pos] || '🎮'}</div>
                    <div class="lane-name">${pos}</div>
                    <div class="lane-winrate" style="color: ${parseFloat(winrate) >= 50 ? 'var(--success)' : 'var(--primary)'}">${winrate}</div>
                    <div style="font-size:0.85rem; color:#888; margin-top:5px;">${games}전 ${wins}승</div>
                    <div style="font-size:0.85rem; color:#666;">KDA: ${kda}</div>
                    <div style="font-size:0.8rem; color:var(--warning); margin-top:5px;">POG: ${pog}</div>
                </div>`;
            }).join('');
        }

        // --- LOGIC: RENDER CHAMPION RANKING ---
        function renderChampRanking(champData) {
            const grid = document.getElementById('champ-ranking-grid');
            if (!champData || champData.length === 0) {
                grid.innerHTML = '<div style="color:#666;">챔피언 데이터가 없습니다.</div>';
                return;
            }

            grid.innerHTML = champData.slice(0, 20).map((row, idx) => {
                const name = row[0] || 'Unknown';
                const games = row[1] || 0;
                const wins = row[2] || 0;
                const kda = row[7] || '0.0';
                const winrate = row[8] || '0%';

                return `
                <div class="champ-rank-card">
                    <div class="champ-rank-img">
                        <img src="${getChampImg(name)}" onerror="this.src='https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Poro_0.jpg'" alt="${name}">
                    </div>
                    <div class="champ-rank-info">
                        <div class="champ-rank-name">${name}</div>
                        <div class="champ-rank-stats">${games}전 ${wins}승 (${winrate})</div>
                        <div class="champ-rank-stats">KDA: ${kda}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- LOGIC: RENDER ELO TIMELINE CHART ---
        function renderEloTimeline(timelineData) {
            if (!timelineData || timelineData.length === 0) return;

            // Group by player
            const playerData = {};
            timelineData.forEach(row => {
                const player = row[2];
                const elo = row[3];
                const matchNum = row[0];
                if (!player) return;
                if (!playerData[player]) playerData[player] = [];
                playerData[player].push({ x: matchNum, y: elo });
            });

            const colors = ['#ff003c', '#00f0ff', '#39ff14', '#ffea00', '#d633ff', '#ff6b6b', '#4ecdc4', '#95e1d3'];
            const players = Object.keys(playerData).slice(0, 8);

            const datasets = players.map((player, idx) => ({
                label: player,
                data: playerData[player],
                borderColor: colors[idx % colors.length],
                backgroundColor: 'transparent',
                tension: 0.3,
                pointRadius: 2
            }));

            const ctx = document.getElementById('eloChart').getContext('2d');
            if (eloChart) eloChart.destroy();

            eloChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#888' } },
                        title: { display: true, text: '선수별 ELO 변화 추이', color: '#fff' }
                    },
                    scales: {
                        x: { type: 'linear', title: { display: true, text: '경기 순번', color: '#666' }, grid: { color: '#222' }, ticks: { color: '#666' } },
                        y: { title: { display: true, text: 'ELO', color: '#666' }, grid: { color: '#222' }, ticks: { color: '#666' } }
                    }
                }
            });

            // Search functionality
            document.getElementById('elo-player-search').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = players.filter(p => p.toLowerCase().includes(query));
                eloChart.data.datasets.forEach(ds => {
                    ds.hidden = !filtered.includes(ds.label);
                });
                eloChart.update();
            });
        }

        // --- MAIN INIT ---
        async function initApp() {
            const loader = document.getElementById('loading-overlay');
            const updateTime = document.getElementById('last-update-time');
            const displayId = document.getElementById('display-sheet-id');
            const connectionStatus = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            const now = new Date();
            
            displayId.textContent = `ID: ${CONFIG.sheetId}`;

            updateTime.textContent = `LAST SYNC: ${now.toLocaleTimeString()}`;

            // Moved initBalancerInputs call to after data fetch so datalist is populated

            if(CONFIG.sheetId === 'YOUR_SHEET_ID_HERE' && !CONFIG.testMode) {
                showToast('구글 시트 ID를 설정해주세요!', 'error');
            }

            const [rankingData, logsData, matchData, laneData, champData, timelineData, db1Data] = await Promise.all([
                fetchData(CONFIG.sheets.ranking, 'SELECT A, B, C'),
                fetchData(CONFIG.sheets.logs, 'SELECT *'),
                fetchData(CONFIG.sheets.matches, 'SELECT *'),
                fetchData(CONFIG.sheets.laneStats, 'SELECT *'),
                fetchData(CONFIG.sheets.champRanking, 'SELECT *'),
                fetchData(CONFIG.sheets.eloTimeline, 'SELECT *'),
                fetchData(CONFIG.sheets.db1, 'SELECT B, D, H') // DB1 시트에서 ID(B), Tier(D), Score(H) 가져오기
            ]);

            const isError = !rankingData && !logsData;
            const isEmpty = rankingData && rankingData.length === 0 && logsData && logsData.length === 0;

            if (isError) {
                showToast('연결 실패: ID와 권한, 탭 이름을 확인해주세요.', 'error');
                displayId.style.color = 'var(--primary)';
                connectionStatus.style.color = 'var(--primary)';
                connectionStatus.textContent = "CONNECTION FAILED (ERROR)";
                // Even on error, we might want to hide loader to show empty state/error logic, 
                // but usually better to keep loader or show error screen. 
                // For now, allow flow to proceed so login screen appears (maybe with error msg)
            }

            if (isEmpty) {
                showToast('연결 성공: 데이터가 비어있습니다.', 'success');
                connectionStatus.style.color = 'var(--success)';
                connectionStatus.textContent = "CONNECTED (EMPTY DATA)";
                statusText.innerHTML = `<i class="fa-solid fa-circle-check" style="color:var(--success)"></i> 연결 성공 (데이터 0건)`;
            } else {
                 statusText.innerHTML = `<i class="fa-solid fa-circle-check" style="color:var(--success)"></i> 구글 시트 실시간 연동됨`;
            }

            GLOBAL_DATA.ranking = rankingData || [];
            GLOBAL_DATA.logs = logsData || [];
            GLOBAL_DATA.matches = matchData || [];
            GLOBAL_DATA.laneStats = laneData || [];
            GLOBAL_DATA.champRanking = champData || [];
            GLOBAL_DATA.eloTimeline = timelineData || [];
            GLOBAL_DATA.db1 = db1Data || [];

            // Update Balancer Data List and Inputs
            updatePlayerDatalist();
            initBalancerInputs();

            if (GLOBAL_DATA.logs) {
                const matchIds = new Set(GLOBAL_DATA.logs.map(row => row[1]));
                document.getElementById('dash-total-games').textContent = matchIds.size;
                const lastLog = GLOBAL_DATA.logs.length > 0 ? GLOBAL_DATA.logs[GLOBAL_DATA.logs.length - 1] : null;
                if(lastLog) {
                    document.getElementById('dash-last-match-id').textContent = lastLog[1] || 'Unknown';
                    document.getElementById('dash-last-match-date').textContent = lastLog[0] || '-';
                } else {
                    document.getElementById('dash-last-match-id').textContent = '-';
                    document.getElementById('dash-last-match-date').textContent = '-';
                }
                updateRisingFalling(GLOBAL_DATA.logs);
                updateTicker(GLOBAL_DATA.logs);
            }

            if (GLOBAL_DATA.ranking && GLOBAL_DATA.ranking.length > 0) {
                const topPlayer = GLOBAL_DATA.ranking[0];
                document.getElementById('dash-top-player').textContent = topPlayer[1];
                document.getElementById('dash-top-mmr').textContent = topPlayer[2];
                document.getElementById('dash-total-players').textContent = GLOBAL_DATA.ranking.length + "명";

                const tbody = document.getElementById('ranking-tbody');
                tbody.innerHTML = '';
                GLOBAL_DATA.ranking.slice(0, 15).forEach(row => {
                    const rank = row[0];
                    const name = row[1];
                    const elo = row[2];
                    let tier = 'GOLD';
                    if (elo >= 1800) tier = '<span style="color:#d633ff">MASTER</span>';
                    else if (elo >= 1600) tier = '<span style="color:#00f0ff">DIAMOND</span>';
                    else if (elo >= 1400) tier = '<span style="color:#39ff14">PLATINUM</span>';
                    tbody.innerHTML += `<tr><td class="${rank <= 3 ? 'rank-' + rank : ''}">${rank}</td><td>${name} ${rank == 1 ? '👑' : ''}</td><td style="font-weight:900; color:#fff;">${elo}</td><td>${tier}</td></tr>`;
                });
            } else {
                document.getElementById('ranking-tbody').innerHTML = '<tr><td colspan="4" style="text-align:center; color:#666;">데이터가 없습니다.</td></tr>';
            }

            renderMatches(matchData);
            renderLaneStats(laneData);
            renderChampRanking(champData);
            renderEloTimeline(timelineData);

            loader.style.opacity = 0;
            setTimeout(() => {
                loader.style.display = 'none';
                // Login overlay stays visible until user logs in
            }, 500);
        }

        window.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>

</html>
